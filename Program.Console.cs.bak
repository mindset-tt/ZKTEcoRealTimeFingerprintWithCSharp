using System;
using System.IO;
using System.Threading;
using System.Threading.Tasks;
using ZKTecoRealTimeLog.Database;

namespace ZKTecoRealTimeLog
{
    class Program
    {
        private static bool _running = true;

        // Multi-device and database managers
        private static MultiDeviceManager? _deviceManager;
        private static MultiDatabaseManager? _databases;
        private static FileLogger? _fileLogger;

        static async Task Main(string[] args)
        {
            Console.WriteLine("===========================================");
            Console.WriteLine("   ZKTEco K40 Real-Time Log Monitor");
            Console.WriteLine("   Multi-Device Edition");
            Console.WriteLine("===========================================");
            Console.WriteLine();

            // Load .env file if exists
            LoadEnvFile();

            // Show help if requested
            if (args.Length > 0 && (args[0] == "-h" || args[0] == "--help" || args[0] == "/?"))
            {
                ShowHelp();
                return;
            }

            // Show database types if requested
            if (args.Length > 0 && args[0] == "--db-types")
            {
                DatabaseFactory.PrintSupportedDatabases();
                return;
            }

            // Initialize file logger
            string logFilePath = Environment.GetEnvironmentVariable("LOG_FILE_PATH") ?? "";
            _fileLogger = new FileLogger(string.IsNullOrWhiteSpace(logFilePath) ? null : logFilePath);
            if (_fileLogger.IsEnabled)
            {
                Console.WriteLine($"Log file: {_fileLogger.LogFilePath}");
            }

            // Initialize multiple databases
            Console.WriteLine("\nInitializing databases...");
            _databases = new MultiDatabaseManager();
            try
            {
                await _databases.InitializeFromEnvironmentAsync();
                
                if (_databases.ActiveCount == 0)
                {
                    Console.WriteLine("  No databases enabled");
                    Console.WriteLine("  (Set POSTGRES_ENABLED=true, MYSQL_ENABLED=true, etc. to enable)");
                }
                else
                {
                    _fileLogger?.LogInfo($"Connected to {_databases.ActiveCount} database(s): {string.Join(", ", _databases.EnabledDatabaseNames)}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"  Database initialization error: {ex.Message}");
                _fileLogger?.LogError($"Database error: {ex.Message}");
            }

            // Load device configurations
            var deviceConfigs = MultiDeviceManager.LoadDeviceConfigs();
            
            if (deviceConfigs.Count == 0)
            {
                Console.WriteLine("\nNo devices configured!");
                Console.WriteLine("Configure devices in .env file:");
                Console.WriteLine("  DEVICE_1_IP=192.168.1.201");
                Console.WriteLine("  DEVICE_1_PORT=4370");
                Console.WriteLine("  DEVICE_1_NAME=Entrance");
                Console.WriteLine();
                Console.WriteLine("Or use legacy single device:");
                Console.WriteLine("  ZKTECO_IP=192.168.1.201");
                Console.WriteLine("  ZKTECO_PORT=4370");
                _fileLogger?.LogError("No devices configured");
                Environment.ExitCode = 1;
                return;
            }

            Console.WriteLine($"\nConnecting to {deviceConfigs.Count} device(s)...");
            _fileLogger?.LogInfo($"Connecting to {deviceConfigs.Count} device(s)");

            // Initialize multi-device manager
            _deviceManager = new MultiDeviceManager();

            // Subscribe to events
            _deviceManager.OnAttendance += HandleAttendanceEvent;
            _deviceManager.OnFingerPlaced += HandleFingerPlaced;
            _deviceManager.OnVerify += HandleVerify;
            _deviceManager.OnCard += HandleCard;
            _deviceManager.OnNewUser += HandleNewUser;
            _deviceManager.OnDisconnected += HandleDisconnected;

            // Connect to all devices
            _deviceManager.ConnectAll(deviceConfigs);

            if (_deviceManager.ConnectedCount == 0)
            {
                Console.WriteLine("\nFailed to connect to any device. Exiting...");
                _fileLogger?.LogError("Failed to connect to any device");
                Environment.ExitCode = 1;
                return;
            }

            _deviceManager.PrintSummary();
            _fileLogger?.LogInfo($"Connected to {_deviceManager.ConnectedCount} device(s)");

            // Handle Ctrl+C gracefully
            Console.CancelKeyPress += (sender, e) =>
            {
                e.Cancel = true;
                _running = false;
                Console.WriteLine("\nShutting down...");
                _fileLogger?.LogInfo("Shutdown requested");
            };

            Console.WriteLine();
            Console.WriteLine("Commands: [R] Read all logs | [I] Device info | [Q] Quit");
            Console.WriteLine("-------------------------------------------");
            Console.WriteLine("\nWaiting for attendance events from all devices...\n");

            // Main loop
            while (_running)
            {
                if (Console.KeyAvailable)
                {
                    var key = Console.ReadKey(true);
                    switch (key.Key)
                    {
                        case ConsoleKey.Q:
                            _running = false;
                            break;
                        case ConsoleKey.R:
                            ReadAllAttendanceLogs();
                            break;
                        case ConsoleKey.I:
                            DisplayAllDeviceInfo();
                            break;
                    }
                }
                Thread.Sleep(100);
            }

            // Cleanup
            Console.WriteLine("Disconnecting from all devices...");
            _deviceManager.DisconnectAll();
            _deviceManager.Dispose();
            
            _fileLogger?.LogInfo("Application stopped");
            _fileLogger?.Dispose();
            _databases?.Dispose();
        }

        private static void HandleAttendanceEvent(ZKDevice device, AttendanceEventArgs args)
        {
            Console.WriteLine();
            LogEvent($"=== ATTENDANCE EVENT [{device.Name}] ===", ConsoleColor.Green);
            Console.WriteLine($"    Device     : {device.Name} ({device.IP})");
            Console.WriteLine($"    Time       : {args.EventTime:yyyy-MM-dd HH:mm:ss}");
            Console.WriteLine($"    User ID    : {args.EnrollNumber}");
            Console.WriteLine($"    Status     : {(args.IsValid ? "Valid" : "Invalid")}");
            Console.WriteLine($"    State      : {args.AttStateDescription}");
            Console.WriteLine($"    Method     : {args.VerifyMethodDescription}");
            if (args.WorkCode != 0)
                Console.WriteLine($"    Work Code  : {args.WorkCode}");
            Console.WriteLine();

            // Log to file
            _fileLogger?.LogAttendance(args.EnrollNumber, args.EventTime, args.IsValid, 
                args.AttState, args.AttStateDescription, args.VerifyMethod, args.VerifyMethodDescription, 
                args.WorkCode, device.Name, device.IP);

            // Save to all enabled databases
            _ = Task.Run(async () =>
            {
                try
                {
                    if (_databases != null && _databases.ActiveCount > 0)
                    {
                        await _databases.InsertAttendanceLogAsync(
                            args.EnrollNumber, args.EventTime, args.IsValid, args.AttState, args.AttStateDescription,
                            args.VerifyMethod, args.VerifyMethodDescription, args.WorkCode, device.IP, device.Name);
                    }
                }
                catch (Exception ex)
                {
                    _fileLogger?.LogError($"DB insert error: {ex.Message}");
                }
            });
        }

        private static void HandleFingerPlaced(ZKDevice device)
        {
            LogEvent($"[{device.Name}] Finger placed on sensor...", ConsoleColor.Cyan);
            _fileLogger?.LogEvent($"[{device.Name}] Finger placed on sensor");
        }

        private static void HandleVerify(ZKDevice device, int userId)
        {
            if (userId == -1)
            {
                LogEvent($"[{device.Name}] Verification FAILED - User not recognized", ConsoleColor.Red);
                _fileLogger?.LogEvent($"[{device.Name}] Verification FAILED - User not recognized");
            }
            else
            {
                LogEvent($"[{device.Name}] Verification successful - User ID: {userId}", ConsoleColor.Yellow);
                _fileLogger?.LogEvent($"[{device.Name}] Verification successful - User ID: {userId}");
            }
        }

        private static void HandleCard(ZKDevice device, int cardNumber)
        {
            if (cardNumber == 0)
            {
                LogEvent($"[{device.Name}] Verification FAILED - Fingerprint not recognized", ConsoleColor.Red);
                _fileLogger?.LogEvent($"[{device.Name}] Verification FAILED - Fingerprint not recognized");
            }
            else
            {
                LogEvent($"[{device.Name}] Card swiped - Card Number: {cardNumber}", ConsoleColor.Blue);
                _fileLogger?.LogEvent($"[{device.Name}] Card swiped - Card Number: {cardNumber}");
            }
        }

        private static void HandleNewUser(ZKDevice device, int enrollNumber)
        {
            LogEvent($"[{device.Name}] New user registered - User ID: {enrollNumber}", ConsoleColor.Magenta);
            _fileLogger?.LogEvent($"[{device.Name}] New user registered - User ID: {enrollNumber}");
        }

        private static void HandleDisconnected(ZKDevice device)
        {
            LogEvent($"[{device.Name}] Device disconnected!", ConsoleColor.Red);
            _fileLogger?.LogWarning($"[{device.Name}] Device disconnected");
        }

        private static void DisplayAllDeviceInfo()
        {
            if (_deviceManager == null) return;

            var infos = _deviceManager.GetAllDeviceInfo();
            Console.WriteLine();
            Log($"--- Device Information ({infos.Count} devices) ---");
            
            foreach (var info in infos)
            {
                Console.WriteLine("-------------------------------------------");
                Console.WriteLine($"  Device Name    : {info.Name}");
                Console.WriteLine($"  IP Address     : {info.IP}:{info.Port}");
                Console.WriteLine($"  Serial Number  : {info.SerialNumber}");
                Console.WriteLine($"  Firmware       : {info.FirmwareVersion}");
                Console.WriteLine($"  Users          : {info.UserCount}");
                Console.WriteLine($"  Fingerprints   : {info.FingerprintCount}");
                Console.WriteLine($"  Attendance Logs: {info.AttendanceLogCount}");
            }
            Console.WriteLine("-------------------------------------------");
            Console.WriteLine();
        }

        private static void ReadAllAttendanceLogs()
        {
            if (_deviceManager == null) return;

            Console.WriteLine();
            Log("--- Reading All Attendance Logs from All Devices ---");

            var logs = _deviceManager.ReadAllLogs();
            
            foreach (var log in logs)
            {
                string timestamp = log.EventTime.ToString("yyyy-MM-dd HH:mm:ss");
                string verifyMethod = GetVerifyMethodName(log.VerifyMethod);
                string state = GetAttStateDescription(log.AttState);
                Console.WriteLine($"  [{log.DeviceName}] [{timestamp}] User: {log.EnrollNumber,-10} Mode: {verifyMethod,-12} State: {state}");
            }

            Log($"--- Total logs: {logs.Count} ---");
            Console.WriteLine();
        }

        private static void ShowHelp()
        {
            Console.WriteLine("Usage: ZKTecoRealTimeLog [options]");
            Console.WriteLine();
            Console.WriteLine("Options:");
            Console.WriteLine("  --help, -h    Show this help message");
            Console.WriteLine("  --db-types    Show supported database types");
            Console.WriteLine();
            Console.WriteLine("Multi-Device Configuration (.env file):");
            Console.WriteLine();
            Console.WriteLine("  # Device 1");
            Console.WriteLine("  DEVICE_1_ENABLED=true");
            Console.WriteLine("  DEVICE_1_NAME=Entrance");
            Console.WriteLine("  DEVICE_1_IP=192.168.1.201");
            Console.WriteLine("  DEVICE_1_PORT=4370");
            Console.WriteLine();
            Console.WriteLine("  # Device 2");
            Console.WriteLine("  DEVICE_2_ENABLED=true");
            Console.WriteLine("  DEVICE_2_NAME=Exit");
            Console.WriteLine("  DEVICE_2_IP=192.168.1.202");
            Console.WriteLine("  DEVICE_2_PORT=4370");
            Console.WriteLine();
            Console.WriteLine("  # Add more devices: DEVICE_3_*, DEVICE_4_*, etc. (up to 20)");
            Console.WriteLine();
            Console.WriteLine("Legacy Single Device (backward compatible):");
            Console.WriteLine("  ZKTECO_IP=192.168.1.201");
            Console.WriteLine("  ZKTECO_PORT=4370");
            Console.WriteLine();
            Console.WriteLine("Multi-Database Configuration:");
            Console.WriteLine("  POSTGRES_ENABLED=true/false");
            Console.WriteLine("  MYSQL_ENABLED=true/false");
            Console.WriteLine("  SQLSERVER_ENABLED=true/false");
            Console.WriteLine("  SQLITE_ENABLED=true/false");
            Console.WriteLine("  ORACLE_ENABLED=true/false");
            Console.WriteLine();
            Console.WriteLine("Prerequisites:");
            Console.WriteLine("  Register zkemkeeper.dll: regsvr32 zkemkeeper.dll (as Admin)");
        }

        private static void LoadEnvFile()
        {
            string envPath = Path.Combine(AppContext.BaseDirectory, ".env");
            if (!File.Exists(envPath))
            {
                envPath = ".env";
            }

            if (File.Exists(envPath))
            {
                try
                {
                    foreach (var line in File.ReadAllLines(envPath))
                    {
                        var trimmed = line.Trim();
                        if (string.IsNullOrEmpty(trimmed) || trimmed.StartsWith("#"))
                            continue;

                        var parts = trimmed.Split('=', 2);
                        if (parts.Length == 2)
                        {
                            var key = parts[0].Trim();
                            var value = parts[1].Trim();
                            if (string.IsNullOrEmpty(Environment.GetEnvironmentVariable(key)))
                            {
                                Environment.SetEnvironmentVariable(key, value);
                            }
                        }
                    }
                    Log("Loaded configuration from .env file");
                }
                catch (Exception ex)
                {
                    Log($"Warning: Could not load .env file: {ex.Message}");
                }
            }
        }

        private static void Log(string message)
        {
            Console.WriteLine($"[{DateTime.Now:yyyy-MM-dd HH:mm:ss}] {message}");
        }

        private static void LogEvent(string message, ConsoleColor color = ConsoleColor.White)
        {
            var originalColor = Console.ForegroundColor;
            Console.ForegroundColor = color;
            Log(message);
            Console.ForegroundColor = originalColor;
        }

        private static string GetVerifyMethodName(int method)
        {
            return method switch
            {
                0 => "Password",
                1 => "Fingerprint",
                2 => "Card",
                3 => "Password+FP",
                4 => "Password+Card",
                5 => "FP+Card",
                6 => "FP+Pwd+Card",
                7 => "Face",
                _ => $"Unknown({method})"
            };
        }

        private static string GetAttStateDescription(int state)
        {
            return state switch
            {
                0 => "Check-In",
                1 => "Check-Out",
                2 => "Break-Out",
                3 => "Break-In",
                4 => "OT-In",
                5 => "OT-Out",
                _ => $"State{state}"
            };
        }
    }
}
